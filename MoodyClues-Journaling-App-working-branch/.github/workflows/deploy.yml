name: Deploy to EC2 (build on runner, pull on EC2)

on:
  push:
    branches: [ "main" ]

concurrency:
  group: deploy-backend
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    env:
      APP_DIR: backend-spring/MoodyClues
      IMAGE_NAME: moodyclues-backend
      REGISTRY_USER: ${{ secrets.DOCKERHUB_USERNAME }}
      REGISTRY_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      EC2_HOST: ${{ secrets.EC2_PUBLIC_IP }}
      EC2_USER: ubuntu
      RDS_USERNAME: ${{ secrets.RDS_USERNAME }}
      RDS_PASSWORD: ${{ secrets.RDS_PASSWORD }}
      RDS_JDBC_URL: jdbc:mysql://moodyclues-db-1.c52ysku4cuy5.ap-southeast-1.rds.amazonaws.com:3306/moodyclues_db?allowPublicKeyRetrieval=true&useSSL=false&serverTimezone=Asia/Singapore

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Temurin JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Flyway migrate from runner (no SSH)
        working-directory: ${{ env.APP_DIR }}
        run: |
          chmod +x mvnw
          ./mvnw -B -Dorg.slf4j.simpleLogger.log.org.flywaydb=debug \
            flyway:migrate \
            -Dflyway.user="${RDS_USERNAME}" \
            -Dflyway.password="${RDS_PASSWORD}" \
            -Dflyway.url="${RDS_JDBC_URL}"

      - name: Build JAR (skip tests)
        working-directory: ${{ env.APP_DIR }}
        run: ./mvnw -B -DskipTests clean package

      - name: Docker login (Docker Hub)
        run: echo "$REGISTRY_TOKEN" | docker login -u "$REGISTRY_USER" --password-stdin

      - name: Build & tag image
        working-directory: ${{ env.APP_DIR }}
        env:
          SHORT_SHA: ${{ github.sha }}
        run: |
          SHORT="${SHORT_SHA:0:7}"
          IMAGE="$REGISTRY_USER/${IMAGE_NAME}"
          docker build -t "$IMAGE:$SHORT" -t "$IMAGE:latest" .
          echo "IMAGE_TAG_SHORT=$IMAGE:$SHORT" >> $GITHUB_ENV
          echo "IMAGE_TAG_LATEST=$IMAGE:latest" >> $GITHUB_ENV

      - name: Push image
        run: |
          docker push "$IMAGE_TAG_SHORT"
          docker push "$IMAGE_TAG_LATEST"

      - name: Recreate PEM key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" | base64 -d > key.pem
          chmod 600 key.pem

      - name: Quick port 22 check
        run: |
          echo "Probing port 22..."
          nc -vz -w 10 "$EC2_HOST" 22 || (echo "Port 22 not reachable"; exit 2)

      - name: Deploy on EC2 (pull & run)
        run: |
          ssh -vvv -tt \
            -o StrictHostKeyChecking=no \
            -o ServerAliveInterval=30 \
            -o ServerAliveCountMax=10 \
            -o TCPKeepAlive=yes \
            -o ConnectTimeout=45 \
            -o ConnectionAttempts=3 \
            -i key.pem "$EC2_USER@$EC2_HOST" << EOF
          set -euo pipefail

          # Heartbeat (escape \$ and \$(...) so they run remotely, not on the runner)
          ( while true; do echo "[deploy][heartbeat] \$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")"; sleep 25; done ) & HB=\$!; trap 'kill \$HB || true' EXIT

          echo "🧼 Stopping/removing existing container (if any)..."
          docker stop moodyclues-container || true
          docker rm moodyclues-container || true

          echo "🔐 Docker login..."
          echo "${REGISTRY_TOKEN}" | docker login -u "${REGISTRY_USER}" --password-stdin

          echo "🐳 Pulling image..."
          docker pull "${REGISTRY_USER}/${IMAGE_NAME}:latest"

          echo "🚀 Starting container..."
          docker run -d --name moodyclues-container -p 8080:8080 "${REGISTRY_USER}/${IMAGE_NAME}:latest"

          echo "🔎 Status:"
          sleep 3
          docker ps --filter "name=moodyclues-container" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          EOF
